<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù†Ø¯Ø§Ù†Ú¯Ø´ØªÛŒ Ø§Ø² Ø¨Ø§Ø²Ù‡Ù” ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ (Û±/Û³ Ù…Ø¯Øª)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 900px; margin: auto; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-12 { grid-column: span 12; }
    label { display: flex; flex-direction: column; gap: 6px; font-size: 14px; }
    input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #bbb; border-radius: 8px; direction: ltr; }
    input[type="number"] { direction: rtl; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    button { padding: 10px 16px; border: 0; border-radius: 8px; cursor: pointer; background: #1e88e5; color: #fff; }
    button.secondary { background: #666; }
    button.danger { background: #d32f2f; }
    .hint { font-size: 12px; color: #666; margin-top: -6px; }
    progress { width: 100%; height: 10px; }
    .log { margin-top: 12px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; color: #333; max-height: 40vh; overflow: auto; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h1>Ø³Ø§Ø®Øª Ø¨Ù†Ø¯Ø§Ù†Ú¯Ø´ØªÛŒ Ø§Ø² Û±/Û³ Ù…Ø¯Øª ÙˆÛŒØ¯Ø¦Ùˆ (Ø¨Ø§Ø²Ù‡Ù” ID)</h1>

  <div class="grid">
    <label class="col-12">
      Ø§Ù„Ú¯ÙˆÛŒ URL ÙˆÛŒØ¯Ø¦Ùˆ (Ø§Ø² {id} Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†)
      <input id="pattern" type="text" value="/videos/videoid{id}.mp4" placeholder="/videos/videoid{id}.mp4">
      <div class="hint">Ù…Ø«Ø§Ù„: /videos/videoid{id}.mp4 â†’ Ø¨Ø±Ø§ÛŒ id=100 Ù…ÛŒâ€ŒØ´ÙˆØ¯ /videos/videoid100.mp4</div>
    </label>

    <label class="col-4">
      Ø§Ø² ID
      <input id="fromId" type="number" inputmode="numeric" value="1" min="0">
    </label>
    <label class="col-4">
      ØªØ§ ID
      <input id="toId" type="number" inputmode="numeric" value="10" min="0">
    </label>
    <label class="col-4">
      Ú¯Ø§Ù…
      <input id="step" type="number" inputmode="numeric" value="1" min="1">
    </label>

    <label class="col-4">
      Ù†Ø³Ø¨Øª Ø²Ù…Ø§Ù† ÙØ±ÛŒÙ… (Û° ØªØ§ Û±)
      <input id="ratio" type="text" value="0.33">
      <div class="hint">Û°Ù«Û³Û³ ÛŒØ¹Ù†ÛŒ Û³Û³Ùª Ø§Ø¨ØªØ¯Ø§ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ</div>
    </label>
    <label class="col-4">
      Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ Ø®Ø±ÙˆØ¬ÛŒ
      <input id="maxW" type="number" inputmode="numeric" value="1280" min="64">
    </label>
    <label class="col-4">
      Ú©ÛŒÙÛŒØª JPG (Û° ØªØ§ Û±)
      <input id="quality" type="text" value="0.9">
    </label>

    <div class="col-12 actions">
      <button id="pickDir">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÙˆØ´Ù‡Ù” Ø®Ø±ÙˆØ¬ÛŒ</button>
      <button id="start">Ø´Ø±ÙˆØ¹</button>
      <button id="stop" class="danger">ØªÙˆÙ‚Ù</button>
      <button id="clearLog" class="secondary">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
    </div>

    <div class="col-12">
      <progress id="prog" value="0" max="100"></progress>
      <div id="status" class="muted">Ø¢Ù…Ø§Ø¯Ù‡</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <video id="v" crossorigin="anonymous" preload="auto" style="display:none"></video>
  <canvas id="c" style="display:none"></canvas>

  <script>
    const $ = id => document.getElementById(id);
    const log = m => ($('log').textContent += m + '\n');
    const setStatus = t => $('status').textContent = t;

    let dirHandle = null;
    let abort = false;

    $('pickDir').onclick = async () => {
      if (!('showDirectoryPicker' in window)) {
        alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡Ù” Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ù¾ÙˆØ´Ù‡ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Chrome/Edge Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† ÛŒØ§ Ø±ÙˆÛŒ Â«Ø´Ø±ÙˆØ¹Â» Ø¨Ø²Ù† ØªØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯.');
        return;
      }
      dirHandle = await window.showDirectoryPicker();
      setStatus('Ù¾ÙˆØ´Ù‡Ù” Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.');
      log('âœ“ Ù¾ÙˆØ´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.');
    };

    $('clearLog').onclick = () => $('log').textContent = '';

    $('stop').onclick = () => {
      abort = true;
      setStatus('Ø¯Ø±Ø­Ø§Ù„ ØªÙˆÙ‚Ù ...');
      log('â›” Ø¯Ø³ØªÙˆØ± ØªÙˆÙ‚Ù ØµØ§Ø¯Ø± Ø´Ø¯.');
    };

    $('start').onclick = async () => {
      try {
        abort = false;
        $('prog').value = 0;
        $('log').textContent = '';

        const pattern = $('pattern').value.trim();
        if (!pattern.includes('{id}')) {
          alert('Ø§Ù„Ú¯ÙˆÛŒ URL Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ {id} Ø¨Ø§Ø´Ø¯.');
          return;
        }

        const fromId = parseInt($('fromId').value, 10);
        const toId   = parseInt($('toId').value, 10);
        const step   = Math.max(1, parseInt($('step').value, 10) || 1);
        const ratio  = Math.min(1, Math.max(0, parseFloat($('ratio').value)));
        const maxW   = Math.max(64, parseInt($('maxW').value, 10) || 1280);
        const quality= Math.min(1, Math.max(0, parseFloat($('quality').value)));

        if (Number.isNaN(fromId) || Number.isNaN(toId) || fromId > toId) {
          alert('Ø¨Ø§Ø²Ù‡Ù” ID Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
          return;
        }

        const ids = [];
        for (let i = fromId; i <= toId; i += step) ids.push(i);

        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...');
        log(`Ø´Ø±ÙˆØ¹: ${ids.length} Ù…ÙˆØ±Ø¯. Ù†Ø³Ø¨Øª=${ratio}ØŒ maxW=${maxW}ØŒ Ú©ÛŒÙÛŒØª=${quality}`);
        if (!dirHandle && !('showDirectoryPicker' in window)) {
          log('Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡Ù” Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯Ø› Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.');
        } else if (!dirHandle) {
          log('Ù‡Ø´Ø¯Ø§Ø±: Ù¾ÙˆØ´Ù‡Ù” Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡Ø› Ù‡Ù†Ú¯Ø§Ù… Ø°Ø®ÛŒØ±Ù‡ØŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªÚ©ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
        }

        let done = 0, ok = 0, fail = 0;
        for (const id of ids) {
          if (abort) break;
          const url = pattern.replace('{id}', id);
          try {
            await processOne(id, url, ratio, maxW, quality);
            ok++;
            log(`âœ“ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${id}.jpg`);
          } catch (e) {
            fail++;
            log(`âœ— Ø®Ø·Ø§ Ø¨Ø±Ø§ÛŒ id=${id}: ${e.message || e}`);
          } finally {
            done++;
            $('prog').value = Math.round((done / ids.length) * 100);
            setStatus(`Ù¾ÛŒØ´Ø±ÙØª: ${done}/${ids.length} â€” Ù…ÙˆÙÙ‚: ${ok} â€” Ø®Ø·Ø§: ${fail}`);
            // ÙˆÙ‚ÙÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ UI
            await new Promise(r => setTimeout(r, 40));
          }
        }

        if (abort) {
          setStatus(`Ù…ØªÙˆÙ‚Ù Ø´Ø¯. Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡: ${done}/${ids.length}ØŒ Ù…ÙˆÙÙ‚: ${ok}ØŒ Ø®Ø·Ø§: ${fail}`);
          log('â›” Ø¹Ù…Ù„ÛŒØ§Øª Ù…ØªÙˆÙ‚Ù Ø´Ø¯.');
        } else {
          setStatus(`ØªÙ…Ø§Ù… Ø´Ø¯. Ù…ÙˆÙÙ‚: ${ok}ØŒ Ø®Ø·Ø§: ${fail}`);
          log('ğŸ‰ Ù¾Ø§ÛŒØ§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´.');
        }
      } catch (e) {
        setStatus('Ø®Ø·Ø§');
        log('Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ: ' + (e.message || e));
      }
    };

    async function processOne(id, url, ratio, maxW, quality) {
      const video = $('v');

      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ØªØ§Ø¯ÛŒØªØ§
      await new Promise((resolve, reject) => {
        const onMeta = () => { cleanup(); resolve(); };
        const onErr  = () => { cleanup(); reject(new Error('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ (URL/CORS)')); };
        const cleanup = () => {
          video.removeEventListener('loadedmetadata', onMeta);
          video.removeEventListener('error', onErr);
        };
        video.addEventListener('loadedmetadata', onMeta, { once: true });
        video.addEventListener('error', onErr, { once: true });
        video.crossOrigin = 'anonymous';
        video.preload = 'auto';
        video.src = url;
        video.load();
      });

      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù‡Ø¯Ù Ùˆ seek
      const dur = Number.isFinite($('v').duration) ? $('v').duration : 0;
      const t = clamp(dur * ratio, 0, Math.max(0, dur - 0.2));
      await new Promise((resolve, reject) => {
        const onSeeked = () => { video.removeEventListener('seeked', onSeeked); resolve(); };
        const onErr = () => { video.removeEventListener('error', onErr); reject(new Error('seek Ù†Ø§Ù…ÙˆÙÙ‚')); };
        video.addEventListener('seeked', onSeeked, { once: true });
        video.addEventListener('error', onErr, { once: true });
        video.currentTime = isFinite(t) ? t : 0;
      });

      // Ø±Ø³Ù… Ø±ÙˆÛŒ canvas
      const blob = await drawToBlob(video, maxW, quality);
      if (!blob) throw new Error('ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');

      // Ø°Ø®ÛŒØ±Ù‡: ØªØ±Ø¬ÛŒØ­ Ø¨Ø§ Ù¾ÙˆØ´Ù‡Ù” Ø§Ù†ØªØ®Ø§Ø¨ÛŒØ› Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ†ØµÙˆØ±Øª Ø¯Ø§Ù†Ù„ÙˆØ¯
      if (dirHandle && 'createWritable' in FileSystemFileHandle.prototype) {
        const fileHandle = await dirHandle.getFileHandle(`${id}.jpg`, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
      } else {
        downloadBlob(blob, `${id}.jpg`);
      }
    }

    function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }

    async function drawToBlob(video, maxW, quality) {
      const canvas = $('c');
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) throw new Error('Ø§Ø¨Ø¹Ø§Ø¯ ÙˆÛŒØ¯Ø¦Ùˆ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');

      const scale = Math.min(1, maxW / w);
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/jpeg', quality));
    }

    function downloadBlob(blob, name) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 0);
    }
  </script>
</body>
</html>